# .github/workflows/build-and-sign.yml

name: üöÄ Build, Package e Rilascio Manuale

# 1. Configurazione del "Pulsante Magico"
# Il workflow parte SOLO quando clicchi "Run workflow" nella tab Actions di GitHub
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Numero Versione (es. 2.1.0)'
        required: true
        default: '2.0.0'

# Questa variabile rende il numero di versione facile da usare in tutto lo script
env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}

jobs:
  # ======================================================================
  # JOB 1: Creazione e Packaging per Windows
  # ======================================================================
  build_windows:
    runs-on: windows-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        # Usa la versione di Python che usi per compilare (es. '3.11')
        python-version: '3.13' 

    - name: üì¶ Install Dependencies & PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üî® Run PyInstaller (Windows)
      # Usa il tuo spec file per la compilazione
      run: pyinstaller --clean SaveState-OneFile.spec

    # üóÑÔ∏è Crea la cartella ZIP con EXE, LICENSE e README (Come faresti a mano)
    - name: üóÑÔ∏è Create Release Zip Package
      shell: powershell # Uso PowerShell per il comando Compress-Archive
      run: |
        $zipName = "SaveState_v${{ env.RELEASE_VERSION }}_Win.zip"
        
        # 1. Crea la cartella che diventer√† lo ZIP
        mkdir release_pack
        
        # 2. Copia i file necessari nella cartella temporanea
        copy dist\SaveState.exe release_pack\
        copy LICENSE release_pack\
        copy README.md release_pack\
        
        # 3. Comprimi il tutto
        Compress-Archive -Path release_pack\* -DestinationPath $zipName
        
    # ‚¨ÜÔ∏è Carica lo ZIP come un "Artifact" (file intermedio)
    - name: ‚¨ÜÔ∏è Upload Windows Package (Unsigned)
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Windows-Package
        path: SaveState_v${{ env.RELEASE_VERSION }}_Win.zip

  # ======================================================================
  # JOB 2: Creazione e Packaging per Linux
  # ======================================================================
  build_linux:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: üì¶ Install Dependencies & PyInstaller
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üî® Run PyInstaller (Linux)
      run: pyinstaller --clean SaveState-OneFile-Linux.spec

    # üóÑÔ∏è Crea la cartella ZIP per Linux
    - name: üóÑÔ∏è Create Release Tarball Package
      # Usiamo tar/gzip, lo standard per Linux
      run: |
        DIR_NAME="SaveState_v${{ env.RELEASE_VERSION }}_Linux"
        
        # 1. Crea la cartella
        mkdir $DIR_NAME
        
        # 2. Copia i file necessari
        cp dist/SaveState $DIR_NAME/
        cp LICENSE $DIR_NAME/
        cp README.md $DIR_NAME/
        
        # 3. Comprimi il tutto in un tar.gz
        tar -czvf SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz $DIR_NAME

    # ‚¨ÜÔ∏è Carica il pacchetto Linux
    - name: ‚¨ÜÔ∏è Upload Linux Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Linux-Package
        path: SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz

  # ======================================================================
  # JOB 3: Creazione della Release su GitHub (si attiver√† dopo la build)
  # ======================================================================
  create_release:
    needs: [build_windows, build_linux] # Aspetta che i job di build abbiano finito
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Download all artifacts
        uses: actions/download-artifact@v4

      - name: üè∑Ô∏è Create GitHub Release Draft
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: SaveState v${{ env.RELEASE_VERSION }}
          draft: true # IMPORTANTISSIMO: Crea una BOZZA. Devi scrivere il changelog e pubblicare tu.
          body: |
            ## Novit√† di SaveState v${{ env.RELEASE_VERSION }}
            
            [INSERISCI QUI IL TUO CHANGELOG DETTAGLIATO]
            
            Grazie per il supporto!
          # Aggiunge i pacchetti Windows e Linux alla bozza di release
          files: |
            SaveState-Windows-Package/*
            SaveState-Linux-Package/*