name: üöÄ Build, Package, and Release (Nuitka & SignPath)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Number (e.g., 2.1.0)'
        required: true
        default: '2.0.0'

env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}

permissions:
  contents: write
  id-token: write

jobs:
  # =========================================================
  # 1. WINDOWS BUILD (Nuitka + Firma)
  # =========================================================
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
                
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    # MODIFICA 1: Installiamo Nuitka e Zstandard
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka zstandard ordered-set

    - name: Restore Secret JSON
      shell: bash
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        python -c "import os; open('cloud_utils/client_secret.json', 'w', encoding='utf-8').write(os.environ['SECRET_CONTENT'])"

    # MODIFICA: Nuitka con TUTTI gli asset (Icone, DB Giochi e SECRET DI GOOGLE)
    - name: Run Nuitka Build
      shell: powershell
      run: |
        # 1. Pulizia della versione
        $rawVersion = "${{ env.RELEASE_VERSION }}"
        if ($rawVersion -match '(\d+(\.\d+)+)') {
            $cleanVersion = $matches[0]
        } else {
            $cleanVersion = "1.0.0"
        }
        Write-Host "Versione pulita per Nuitka: $cleanVersion"

        # MODIFICA DEBUG: Console ATTIVA + Import Manuali
    - name: Run Nuitka Build
      shell: powershell
      run: |
        # 1. Pulizia della versione
        $rawVersion = "${{ env.RELEASE_VERSION }}"
        if ($rawVersion -match '(\d+(\.\d+)+)') {
            $cleanVersion = $matches[0]
        } else {
            $cleanVersion = "1.0.0"
        }
        Write-Host "Versione pulita per Nuitka: $cleanVersion"

        # MODIFICA FINALE: Console DISABILITATA + Rimossi blocchi bloat
    - name: Run Nuitka Build
      shell: powershell
      run: |
        # 1. Pulizia della versione
        $rawVersion = "${{ env.RELEASE_VERSION }}"
        if ($rawVersion -match '(\d+(\.\d+)+)') {
            $cleanVersion = $matches[0]
        } else {
            $cleanVersion = "1.0.0"
        }
        Write-Host "Versione pulita per Nuitka: $cleanVersion"

        # 2. Comando Nuitka Finale
        # Rimosso: --nofollow-import-to
        
        python -m nuitka --onefile --standalone `
          --enable-plugin=pyside6 `
          --windows-console-mode=disable `
          --company-name="SaveState[OSS]" `
          --product-name="SaveState" `
          --file-version="$cleanVersion" `
          --product-version="$cleanVersion" `
          --windows-icon-from-ico=icon.ico `
          --output-dir=dist `
          --output-filename=SaveState.exe `
          --assume-yes-for-downloads `
          --include-module=winshell `
          --include-module=win32com `
          --include-module=vdf `
          --include-module=nbtlib `
          --include-module=thefuzz `
          --include-module=psutil `
          --include-module=xml.etree.ElementTree `
          --include-module=configparser `
          --include-data-dir=icons=icons `
          --include-data-file=splash.png=splash.png `
          --include-data-file=icon.png=icon.png `
          --include-data-file=backup_runner.py=backup_runner.py `
          --include-data-file=emulator_utils/citra_titles_map.pkl=emulator_utils/citra_titles_map.pkl `
          --include-data-file=emulator_utils/switch_game_map.pkl=emulator_utils/switch_game_map.pkl `
          --include-data-file=emulator_utils/ps4_game_map.pkl=emulator_utils/ps4_game_map.pkl `
          --include-data-file=emulator_utils/xenia_title_map.pkl=emulator_utils/xenia_title_map.pkl `
          --include-data-file=cloud_utils/client_secret.json=cloud_utils/client_secret.json `
          main.py

    # --- SIGNPATH (Nessuna modifica necessaria qui) ---
    - name: Upload Unsigned EXE
      id: upload_step
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-exe
        path: dist/SaveState.exe
        retention-days: 1

    - name: Sign with SignPath
      uses: signpath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
        project-slug: "SaveState"
        signing-policy-slug: "release-signing"
        artifact-configuration-slug: "zip-with-exe"
        github-artifact-id: ${{ steps.upload_step.outputs.artifact-id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        wait-for-completion: true 
        output-artifact-directory: "dist_signed_temp"

    - name: Handle Signed Artifact
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path dist_signed_final
        $exeFile = Get-ChildItem dist_signed_temp\*.exe | Select-Object -First 1
        $zipFile = Get-ChildItem dist_signed_temp\*.zip | Select-Object -First 1

        if ($exeFile) {
            Move-Item -Path $exeFile.FullName -Destination dist_signed_final\SaveState.exe
        }
        elseif ($zipFile) {
            Expand-Archive -Path $zipFile.FullName -DestinationPath dist_signed_final
        }
        else {
            exit 1
        }

    # --- IMPACCHETTAMENTO WINDOWS ---
    - name: Create Release Zip Package
      shell: powershell
      run: |
        $zipName = "SaveState_v${{ env.RELEASE_VERSION }}_Win.zip"
        mkdir release_pack
        copy dist_signed_final\SaveState.exe release_pack\
        copy LICENSE release_pack\
        copy README.md release_pack\
        Compress-Archive -Path release_pack\* -DestinationPath $zipName
        
    - name: Upload Windows Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Windows-Package
        path: SaveState_v${{ env.RELEASE_VERSION }}_Win.zip

  # =========================================================
  # 2. LINUX BUILD (Lasciato invariato o puoi usare Nuitka anche qui)
  # =========================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: üì¶ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev fuse libfuse2 file
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üîê Restore Secret JSON
      shell: bash  
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        python -c "import os; open('cloud_utils/client_secret.json', 'w', encoding='utf-8').write(os.environ['SECRET_CONTENT'])"

    - name: üî® Run PyInstaller (Linux)
      run: pyinstaller --clean SaveState-OneFile-Linux.spec

    # --- CREAZIONE APPIMAGE (Logica Icone Avanzata) ---
    - name: üñºÔ∏è Prepare AppDir Structure
      run: |
        rm -rf AppDir
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
        mkdir -p AppDir/usr/share/pixmaps/

        cp dist/SaveState AppDir/usr/bin/
        cp icon.png AppDir/SaveState.png
        cp icon.png AppDir/usr/share/pixmaps/SaveState.png
        ln -s ../../../../../../SaveState.png AppDir/usr/share/icons/hicolor/256x256/apps/SaveState.png
        cd AppDir
        ln -s SaveState.png .DirIcon
        cd ..

    - name: üìù Create .desktop file
      run: |
        cat > AppDir/SaveState.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=SaveState
        Exec=SaveState
        Icon=SaveState
        Categories=Utility;
        Terminal=false
        StartupWMClass=SaveState
        EOF

    - name: üöÄ Build AppImage
      run: |
        wget -O appimagetool "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool
        ln -s usr/bin/SaveState AppDir/AppRun
        ARCH=x86_64 ./appimagetool AppDir SaveState.AppImage
        cp SaveState.AppImage "SaveState_v${{ env.RELEASE_VERSION }}.AppImage"

    - name: üóÑÔ∏è Create Release Tarball Package
      run: |
        DIR_NAME="SaveState" 
        TARBALL_NAME="SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.xz"
        mkdir -p "$DIR_NAME"
        mv "SaveState.AppImage" "$DIR_NAME/"
        cp LICENSE "$DIR_NAME/"
        cp README.md "$DIR_NAME/"
        # Use XZ with maximum compression (-9e) for better compression on already-compressed AppImage
        tar -cvf - "$DIR_NAME" | xz -9e --threads=0 > "$TARBALL_NAME"
        echo "üì¶ Dimensione pacchetto finale:"
        ls -lh "$TARBALL_NAME"

    - name: ‚¨ÜÔ∏è Upload Linux Tarball Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Linux-Package
        path: "SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.xz"

    - name: ‚¨ÜÔ∏è Upload Standalone AppImage
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-AppImage-Standalone
        path: "SaveState_v${{ env.RELEASE_VERSION }}.AppImage"

  # =========================================================
  # 3. RELEASE CREATION
  # =========================================================
  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download all artifacts
        uses: actions/download-artifact@v4

      - name: üöÄ Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.MY_RELEASE_TOKEN }}
        run: |
          echo "Creating Release v${{ env.RELEASE_VERSION }}..."
          gh release create v${{ env.RELEASE_VERSION }} \
            SaveState-Windows-Package/* \
            SaveState-Linux-Package/* \
            SaveState-AppImage-Standalone/* \
            --title "SaveState v${{ env.RELEASE_VERSION }}" \
            --draft \
            --generate-notes