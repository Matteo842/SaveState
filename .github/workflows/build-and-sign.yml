name: üöÄ Build, Package, and Release (PowerShell)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Number (e.g., 2.1.0)'
        required: true
        default: '2.0.0'

env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}

permissions:
  contents: read
  id-token: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
                
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Restore Secret JSON
      shell: bash
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        python -c "import os; open('cloud_utils/client_secret.json', 'w', encoding='utf-8').write(os.environ['SECRET_CONTENT'])"

    - name: Run PyInstaller
      run: pyinstaller --clean SaveState-OneFile.spec

    # üî• QUI IL FIX: UPLOAD COME FILE, NON COME CARTELLA
    - name: Upload unsigned EXE
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-exe
        path: dist/SaveState.exe
        retention-days: 1

    # üî• SIGNPATH: ORA GLI PASSIAMO IL FILE DIRETTAMENTE
    - name: Sign EXE with SignPath
      uses: signpath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
        project-slug: "SaveState"
        signing-policy-slug: "test-signing"
        artifact-configuration-slug: "initial"
        github-artifact-name: "unsigned-exe"
        github-artifact-path: "SaveState.exe"
        wait-for-completion: true
        output-artifact-directory: "dist_signed"

    - name: Create Release Zip Package
      shell: powershell
      run: |
        $zipName = "SaveState_v${{ env.RELEASE_VERSION }}_Win.zip"
        mkdir release_pack
        copy dist_signed\SaveState.exe release_pack\
        copy LICENSE release_pack\
        copy README.md release_pack\
        Compress-Archive -Path release_pack\* -DestinationPath $zipName
        
    - name: Upload Windows Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Windows-Package
        path: SaveState_v${{ env.RELEASE_VERSION }}_Win.zip


  # ===========================
  # LINUX BUILD (Invariato)
  # ===========================
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: üì¶ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üîê Restore Secret JSON
      shell: bash  
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        python -c "import os; open('cloud_utils/client_secret.json', 'w', encoding='utf-8').write(os.environ['SECRET_CONTENT'])"

    - name: üî® Run PyInstaller (Linux)
      run: pyinstaller --clean SaveState-OneFile-Linux.spec

    - name: üóÑÔ∏è Create Release Tarball Package
      run: |
        DIR_NAME="SaveState_v${{ env.RELEASE_VERSION }}_Linux"
        mkdir -p "$DIR_NAME"
        cp -r dist/SaveState* "$DIR_NAME/"
        cp LICENSE "$DIR_NAME/"
        cp README.md "$DIR_NAME/"
        tar -czvf "SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz" "$DIR_NAME"

    - name: ‚¨ÜÔ∏è Upload Linux Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Linux-Package
        path: "SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz"

  # ===========================
  # RELEASE CREATION (Invariato)
  # ===========================
  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download all artifacts
        uses: actions/download-artifact@v4

      - name: üöÄ Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.MY_RELEASE_TOKEN }}
        run: |
          echo "Creating Release v${{ env.RELEASE_VERSION }}..."
          gh release create v${{ env.RELEASE_VERSION }} \
            SaveState-Windows-Package/* \
            SaveState-Linux-Package/* \
            --title "SaveState v${{ env.RELEASE_VERSION }}" \
            --draft \
            --generate-notes