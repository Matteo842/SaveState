# .github/workflows/build-and-sign.yml

name: üöÄ Build, Package e Rilascio Manuale

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Numero Versione (es. 2.1.0)'
        required: true
        default: '2.0.0'

env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}

# Diamo i permessi di scrittura a tutto il workflow
permissions:
  contents: write

jobs:
  # ===========================
  # WINDOWS BUILD
  # ===========================
  build_windows:
    runs-on: windows-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13' 

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üîê Restore Secret JSON
      shell: powershell
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        $env:SECRET_CONTENT | Out-File -FilePath cloud_utils\client_secret.json -Encoding utf8

    - name: üî® Run PyInstaller (Windows)
      run: pyinstaller --clean SaveState-OneFile.spec

    - name: üóÑÔ∏è Create Release Zip Package
      shell: powershell
      run: |
        $zipName = "SaveState_v${{ env.RELEASE_VERSION }}_Win.zip"
        mkdir release_pack
        copy dist\SaveState.exe release_pack\
        copy LICENSE release_pack\
        copy README.md release_pack\
        Compress-Archive -Path release_pack\* -DestinationPath $zipName
        
    - name: ‚¨ÜÔ∏è Upload Windows Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Windows-Package
        path: SaveState_v${{ env.RELEASE_VERSION }}_Win.zip

  # ===========================
  # LINUX BUILD
  # ===========================
  build_linux:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: üì¶ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: üîê Restore Secret JSON
      env:
        SECRET_CONTENT: ${{ secrets.CLIENT_SECRET_JSON }}
      run: |
        echo "$SECRET_CONTENT" > cloud_utils/client_secret.json

    - name: üî® Run PyInstaller (Linux)
      run: pyinstaller --clean SaveState-OneFile-Linux.spec

    - name: üóÑÔ∏è Create Release Tarball Package
      run: |
        DIR_NAME="SaveState_v${{ env.RELEASE_VERSION }}_Linux"
        mkdir -p "$DIR_NAME"
        cp -r dist/SaveState* "$DIR_NAME/"
        cp LICENSE "$DIR_NAME/"
        cp README.md "$DIR_NAME/"
        tar -czvf "SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz" "$DIR_NAME"

    - name: ‚¨ÜÔ∏è Upload Linux Package
      uses: actions/upload-artifact@v4
      with:
        name: SaveState-Linux-Package
        path: "SaveState_v${{ env.RELEASE_VERSION }}_Linux.tar.gz"

  # ===========================
  # RELEASE CREATION (FIXED)
  # ===========================
  create_release:
    needs: [build_windows, build_linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ridondante ma sicuro
    steps:
      # FIX 1: Dobbiamo scaricare il codice per poter creare il tag git!
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download all artifacts
        uses: actions/download-artifact@v4

      # FIX 2: Creiamo il tag manualmente identificandoci come bot
      - name: üè∑Ô∏è Push Tag Manually
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Crea il tag se non esiste
          git tag v${{ env.RELEASE_VERSION }} || echo "Tag exists"
          
          # Spinge il tag su GitHub
          git push origin v${{ env.RELEASE_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Create GitHub Release Draft
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: SaveState v${{ env.RELEASE_VERSION }}
          draft: true
          body: |
            ## Novit√† di SaveState v${{ env.RELEASE_VERSION }}
            (Scrivi qui il changelog...)
          files: |
            SaveState-Windows-Package/*
            SaveState-Linux-Package/*